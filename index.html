<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Schedule | Neat & Necessary</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        /* --- 1. GLOBAL VARIABLES & RESET --- */
        :root {
            --bg-body: #09090b;       /* Ultra Dark Background */
            --bg-panel: #18181b;      /* Panel Background */
            --bg-hover: #27272a;      /* Hover State */
            --border: #27272a;        /* Subtle Borders */
            --text-main: #e4e4e7;     /* High Contrast Text */
            --text-muted: #a1a1aa;    /* Secondary Text */
            --primary: #22c55e;       /* Brand Green */
            --primary-glow: rgba(34, 197, 94, 0.15);
            --danger: #ef4444;        /* Red */
            --radius: 8px;            /* Standard curvature */
        }

        * { box-sizing: border-box; }

        /* Scope specifically to Admin Root to avoid breaking Webflow nav */
        #admin-root {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 85vh; /* Adjusted for Webflow embedding */
            min-height: 600px;
            overflow: hidden; 
            display: flex;
            border: 1px solid var(--border);
            border-radius: 12px;
            position: relative;
            z-index: 10;
        }

        /* --- 2. SIDEBAR (FILTERS & GROUPS) --- */
        .app-sidebar {
            width: 280px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 20;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .brand-title {
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.02em;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
        }
        .brand-dot { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 8px var(--primary); }

        .sidebar-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Filter Sections */
        .filter-section-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 12px;
        }

        .custom-select {
            width: 100%;
            background: var(--bg-body);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px 12px;
            border-radius: var(--radius);
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
            cursor: pointer;
        }
        .custom-select:focus { border-color: var(--primary); }

        /* Staff List Visuals */
        .staff-list { display: flex; flex-direction: column; gap: 4px; }
        .staff-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .staff-item:hover { background: var(--bg-hover); }
        .staff-avatar {
            width: 24px; height: 24px;
            border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; color: white;
        }
        .staff-name { font-size: 13px; color: var(--text-main); }
        .staff-status { width: 6px; height: 6px; border-radius: 50%; background: var(--border); margin-left: auto; }
        .staff-item.active .staff-status { background: var(--primary); }

        /* --- 3. MAIN WORKSPACE --- */
        .app-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0; /* Flexbox safety */
            background: var(--bg-body);
        }

        /* Top Toolbar */
        .toolbar {
            height: 64px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background: rgba(9, 9, 11, 0.8);
            backdrop-filter: blur(8px);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .date-navigator {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .nav-icon-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-main);
            width: 32px; height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        .nav-icon-btn:hover { background: var(--bg-hover); border-color: var(--text-muted); }

        .current-range {
            font-size: 15px;
            font-weight: 600;
        }

        .primary-btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .primary-btn:hover { opacity: 0.9; }

        /* Calendar Grid */
        .calendar-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .grid-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 10px;
        }
        .day-label {
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            padding-bottom: 8px;
        }
        .day-label.today { color: var(--primary); font-weight: 700; }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .day-column {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .day-column:hover { border-color: #3f3f46; }

        .day-col-header {
            padding: 12px;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            border-bottom: 1px solid var(--border);
            background: rgba(255,255,255,0.02);
        }
        .day-col-body {
            flex: 1;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        /* Click target for adding shifts */
        .day-col-body:hover { cursor: crosshair; }

        /* Shift Cards */
        .shift-pill {
            background: #27272a;
            border-left: 3px solid var(--text-muted);
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.1s, filter 0.1s;
            position: relative;
            overflow: hidden;
        }
        .shift-pill {
    transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
}

.shift-pill:hover {
    transform: scale(1.05);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 0 10px var(--primary-glow);
    z-index: 50;
    filter: brightness(1.1);
}

.shift-pill:active {
    transform: scale(0.95);
}
        
        .pill-time { font-size: 11px; font-weight: 700; color: var(--text-main); display: block; margin-bottom: 2px;}
        .pill-name { font-size: 12px; color: var(--text-muted); }
        .pill-loc { 
            position: absolute; top: 4px; right: 4px; 
            font-size: 9px; padding: 2px 4px; background: rgba(0,0,0,0.3); border-radius: 3px; 
            text-transform: uppercase; font-weight: 600; opacity: 0.7;
        }

        /* --- 4. MODAL --- */
        .modal-backdrop {
            display: none;
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            align-items: center; justify-content: center;
        }
        .modal-card {
            background: #18181b;
            border: 1px solid #3f3f46;
            width: 400px;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            animation: modalPop 0.2s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes modalPop { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); }}

        .modal-title { font-size: 18px; font-weight: 600; margin: 0 0 20px 0; color: white; }
        
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; color: var(--text-muted); margin-bottom: 6px; font-weight: 500; }
        .form-input {
            width: 100%; background: #09090b; border: 1px solid var(--border);
            color: white; padding: 10px; border-radius: 6px; font-size: 14px; outline: none;
        }
        .form-input:focus { border-color: var(--primary); }

        .modal-actions { display: flex; gap: 10px; margin-top: 24px; }
        .btn-full { flex: 1; height: 40px; }
        .btn-outline { background: transparent; border: 1px solid var(--danger); color: var(--danger); }
        .btn-outline:hover { background: rgba(239, 68, 68, 0.1); }
    </style>
</head>
<body>

<div id="admin-root">
    <div class="app-sidebar">
        <div class="sidebar-header">
            <div class="brand-title">
                <div class="brand-dot"></div>
                Admin Console
            </div>
        </div>

        <div class="sidebar-content">
            <div>
                <div class="filter-section-title">Filter by Location</div>
                <select id="filterArea" class="custom-select">
                    <option value="ALL">All Service Areas</option>
                    <option value="Billings">Billings</option>
                    <option value="Bozeman">Bozeman</option>
                    <option value="Missoula">Missoula</option>
                </select>
            </div>

            <div>
                <div class="filter-section-title">Filter by Staff</div>
                <select id="filterCleaner" class="custom-select">
                    <option value="ALL">All Cleaners</option>
                </select>
            </div>

<div>
    <div class="filter-section-title">Job Status</div>
    <select id="filterJobStatus" class="custom-select">
        <option value="ALL">Show All Jobs</option>
        <option value="UNASSIGNED">Unassigned Only</option>
        <option value="ASSIGNED">Assigned Only</option>
        <option value="CONFLICT">Conflicts Only</option>
    </select>
</div>

            <div>
                <div class="filter-section-title" style="margin-top:20px;">Active Roster</div>
                <div id="staffListContainer" class="staff-list">
                    </div>
            </div>
        </div>
    </div>

    <div class="app-main">
        <div class="toolbar">
            <div class="date-navigator">
                <button class="nav-icon-btn" id="prevBtn" title="Previous Week">&larr;</button>
                <button class="nav-icon-btn" id="todayBtn">T</button>
                <button class="nav-icon-btn" id="nextBtn" title="Next Week">&rarr;</button>
<div style="margin-left: 12px; display: flex; gap: 4px; background: var(--bg-panel); padding: 4px; border-radius: 6px; border: 1px solid var(--border);">
    <button class="primary-btn" id="viewWeek" style="padding: 4px 12px; font-size: 11px;">Week</button>
    <button class="primary-btn" id="viewMonth" style="padding: 4px 12px; font-size: 11px; background: transparent; color: var(--text-muted);">Month</button>
</div>
                <span class="current-range" id="dateLabel">Loading...</span>
            </div>
            
            <div>
                <button class="primary-btn" onclick="openModal()">+ Add Shift</button>
            </div>
        </div>

        <div class="calendar-container">
            <div class="grid-header" id="headerRow"></div>
            
            <div class="main-grid" id="mainGrid"></div>
        </div>
    </div>

	<div class="modal-backdrop" id="detailModal" style="display:none; align-items: center; justify-content: center;">
    <div class="modal-card" style="width: 500px; transform: scale(1.1); border: 1px solid var(--primary);">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <h2 id="detailTitle" style="margin: 0; color: var(--primary);">Shift Details</h2>
            <button class="nav-icon-btn" onclick="closeDetailModal()">✕</button>
        </div>
        
        <div id="detailContent" style="display: flex; flex-direction: column; gap: 16px;">
            <div class="form-group">
                <label class="form-label">Cleaner</label>
                <div id="viewCleaner" style="font-size: 18px; font-weight: 700;"></div>
            </div>
            
            <div style="display: flex; gap: 24px;">
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <div id="viewDate" style="font-size: 16px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Time</label>
                    <div id="viewTime" style="font-size: 16px;"></div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Service Area</label>
                <div id="viewArea" style="font-size: 16px; display: flex; align-items: center; gap: 8px;"></div>
            </div>
        </div>

        <div class="modal-actions" style="margin-top: 32px;">
            <button class="primary-btn btn-full" id="editFromDetail">Edit Shift</button>
            <button class="primary-btn btn-full btn-outline" onclick="closeDetailModal()">Close</button>
        </div>
    </div>
</div>

    <div class="modal-backdrop" id="scheduleModal">
        <div class="modal-card">
            <h3 class="modal-title" id="modalTitle">Manage Shift</h3>
            <input type="hidden" id="slotId">
            
            <div class="form-group">
                <label class="form-label">Team Member</label>
                <select id="modalCleaner" class="form-input"></select>
            </div>

            <div class="form-group">
                <label class="form-label">Date</label>
                <input type="date" id="modalDate" class="form-input">
            </div>

            <div style="display:flex; gap:12px;">
                <div class="form-group" style="flex:1;">
                    <label class="form-label">Start Time</label>
                    <select id="modalStart" class="form-input"></select>
                </div>
                <div class="form-group" style="flex:1;">
                    <label class="form-label">End Time</label>
                    <select id="modalEnd" class="form-input"></select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Service Area</label>
                <select id="modalArea" class="form-input">
                    <option value="">No Area Assigned</option>
                    <option value="Billings">Billings</option>
                    <option value="Bozeman">Bozeman</option>
                    <option value="Missoula">Missoula</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="primary-btn btn-full" id="saveBtn">Save Changes</button>
                <button class="primary-btn btn-full btn-outline" id="deleteBtn" style="display:none;">Delete</button>
                <button class="nav-icon-btn" style="width:40px;" onclick="closeModal()">✕</button>
            </div>



        </div>
    </div>
</div>

<script>
    // --- WEBFLOW DUPLICATE PROTECTION ---
    // This check stops the script if Webflow tries to load it twice
    if (window.adminCalendarInit) {
        console.log("Admin Calendar already initialized. Skipping duplicate load.");
    } else {
        window.adminCalendarInit = true;

        // --- 1. CONFIGURATION ---
        const CONFIG = {
            SUPABASE_URL: "https://rfdvogakvyodixgpvqvz.supabase.co", 
            SUPABASE_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmZHZvZ2FrdnlvZGl4Z3B2cXZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcwMzU4MDMsImV4cCI6MjA4MjYxMTgwM30.UumTuz6AaKL8uYmmNxFj1ec5CInHVNQowt6LRo4cu-E".trim()
        };

        // Reuse connection if it exists, otherwise create new
        window.adminSupabase = window.adminSupabase || window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        const supabase = window.adminSupabase;
        
        // --- STATE ---
        // Declare globally at the top of the script
window.staffMap = window.staffMap || {};
let staffMap = window.staffMap;
window.allShifts = window.allShifts || [];
let currentDate = new Date();
let currentView = 'week'; // Default view
        const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#22c55e', '#06b6d4'];

        // --- INIT ---
        async function initApp() {
            generateTimeOptions();
            renderCalendarSkeleton(); 
            
            // Listeners
            
            document.getElementById('prevBtn').onclick = () => currentView === 'week' ? jumpDate(-7) : jumpMonth(-1);
document.getElementById('nextBtn').onclick = () => currentView === 'week' ? jumpDate(7) : jumpMonth(1);

document.getElementById('viewWeek').onclick = () => switchView('week');
document.getElementById('viewMonth').onclick = () => switchView('month');

function jumpMonth(val) {
    currentDate.setMonth(currentDate.getMonth() + val);
    refreshUI();
}

function switchView(view) {
    currentView = view;
    document.getElementById('viewWeek').style.background = view === 'week' ? 'var(--primary)' : 'transparent';
    document.getElementById('viewWeek').style.color = view === 'week' ? '#000' : 'var(--text-muted)';
    document.getElementById('viewMonth').style.background = view === 'month' ? 'var(--primary)' : 'transparent';
    document.getElementById('viewMonth').style.color = view === 'month' ? '#000' : 'var(--text-muted)';
    refreshUI();
}
            document.getElementById('todayBtn').onclick = () => { currentDate = new Date(); refreshUI(); };
            document.getElementById('filterArea').onchange = refreshUI;
            document.getElementById('filterCleaner').onchange = refreshUI;
document.getElementById('filterJobStatus').onchange = refreshUI;
            
            document.getElementById('saveBtn').onclick = saveShift;
            document.getElementById('deleteBtn').onclick = deleteShift;

            // Load Data
            await loadData();
        }

       // --- DATA ---
window.loadData = async function loadData() {
    const supabase = window.adminSupabase;

    const [availRes, jobsRes, assignRes, usersRes] = await Promise.all([
        supabase.from('cleaner_availability_time_slots').select('*'),
        supabase.from('jobs').select('*'),
        supabase.from('job_assignments').select('*'),
        supabase
  .from('profiles')
  .select('id,email,name,role')
  .eq('role', 'cleaner')

    ]);

	// --- CANONICAL STAFF MAP (FROM PROFILES) ---
window.staffMap = {};
window.staffById = {};

(usersRes.data || []).forEach(u => {
    const name = u.name || u.email;

    window.staffMap[name] = {
        id: u.id,
        email: u.email,
        name,
        initials: name.split(' ').map(n => n[0]).join('').slice(0,2).toUpperCase(),
        color: '#22c55e'
    };

    window.staffById[u.id] = window.staffMap[name];
});

console.log("STAFF MAP READY:", window.staffMap);


    // --- BUILD ID → EMAIL MAP (SOURCE OF TRUTH) ---
    window.profileById = {};
    (usersRes.data || []).forEach(p => {
        window.profileById[p.id] = p.email;
    });


    // Create a temporary map of ID -> Email
    window.cleanerEmailMap = {};
    (usersRes.data || []).forEach(u => {
        window.cleanerEmailMap[u.id] = u.email;
    });


    if (availRes.error) console.error("AVAIL ERROR", availRes.error);
if (jobsRes.error) console.error("JOBS ERROR", jobsRes.error);
if (assignRes.error) console.error("ASSIGN ERROR", assignRes.error);

    
    window.allShifts = availRes.data || [];
    window.allJobs = jobsRes.data || [];
	console.log("ALL JOBS LOADED:", window.allJobs);

    window.allAssignments = assignRes.data || []; // NEW: Store assignments globally
    
    processStaff();
populateAssignCleanerSelect();
refreshUI();

}

       function processStaff() {
    const filterSelect = document.getElementById('filterCleaner');
    const modalSelect = document.getElementById('modalCleaner');
    const listContainer = document.getElementById('staffListContainer');

    filterSelect.innerHTML = '<option value="ALL">All Cleaners</option>';
    modalSelect.innerHTML = '<option value="" disabled selected>Select Staff...</option>';
    listContainer.innerHTML = '';

    let idx = 0;

    Object.values(window.staffMap).forEach(staff => {
        const color = colors[idx % colors.length];
        staff.color = color;
        idx++;

        filterSelect.add(new Option(staff.name, staff.name));
        modalSelect.add(new Option(staff.name, staff.name));

        const item = document.createElement('div');
        item.className = 'staff-item';
        item.innerHTML = `
            <div class="staff-avatar" style="background:${color}">
                ${staff.initials}
            </div>
            <span class="staff-name">${staff.name}</span>
            <div class="staff-status"></div>
        `;

        item.onclick = () => {
            filterSelect.value = staff.name;
            refreshUI();
        };

        listContainer.appendChild(item);
    });
}



        // --- RENDERING ---
      function refreshUI() {
    const grid = document.getElementById('mainGrid');
    const headerRow = document.getElementById('headerRow');
    if(!grid || !headerRow) return;

    grid.innerHTML = '';
    headerRow.innerHTML = '';

    const areaFilter = document.getElementById('filterArea').value;
    const staffFilter = document.getElementById('filterCleaner').value;
const jobStatusFilter = document.getElementById('filterJobStatus').value;

    let startDate, totalDays;

    if (currentView === 'week') {
        startDate = getStartOfWeek(new Date(currentDate));
        totalDays = 7;
        grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
        const endOfWeek = new Date(startDate);
        endOfWeek.setDate(startDate.getDate() + 6);
        document.getElementById('dateLabel').innerText = `${formatDate(startDate)} - ${formatDate(endOfWeek)}`;
    } else {
        // Month View Logic
        const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        startDate = getStartOfWeek(firstDayOfMonth); // Start on the Sunday before the 1st
        totalDays = 42; // standard 6-week grid
        grid.style.gridTemplateColumns = 'repeat(7, 1fr)';
        document.getElementById('dateLabel').innerText = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    }

    // Render Headers (Sun - Sat)
    const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    days.forEach(d => {
        const th = document.createElement('div');
        th.className = 'day-label';
        th.innerText = d;
        headerRow.appendChild(th);
    });

    for(let i=0; i < totalDays; i++) {
        const day = new Date(startDate);
        day.setDate(startDate.getDate() + i);
       const dateKey = day.getFullYear() + '-' +
    String(day.getMonth() + 1).padStart(2, '0') + '-' +
    String(day.getDate()).padStart(2, '0');

        const isToday = new Date().toDateString() === day.toDateString();
        const isCurrentMonth = day.getMonth() === currentDate.getMonth();

        const col = document.createElement('div');
        col.className = 'day-column';
        col.style.minHeight = currentView === 'week' ? '400px' : '120px'; // Shrink cells for month view
        if(!isCurrentMonth && currentView === 'month') col.style.opacity = '0.3';
        if(isToday) col.style.borderColor = 'var(--primary)';

        col.innerHTML = `
            <div class="day-col-header" style="padding: 4px; font-size: 11px;">${day.getDate()}</div>
            <div class="day-col-body" id="col-${dateKey}" style="gap: 2px; padding: 4px;"></div>
        `;
        
        col.querySelector('.day-col-body').onclick = (e) => {
            if(e.target === e.currentTarget) openModal(null, dateKey);
        };

        grid.appendChild(col);
        const container = col.querySelector('.day-col-body');
        
        const shifts = window.allShifts.filter(s => {
            if(s.date !== dateKey) return false;
            if(areaFilter !== "ALL" && s.service_area !== areaFilter) return false;
            if(staffFilter !== "ALL" && s.user_name !== staffFilter) return false;
            return true;
        });

        shifts.sort((a,b) => a.start_time.localeCompare(b.start_time));

        shifts.forEach(shift => {
            const meta = (window.staffMap && window.staffMap[shift.user_name]) ? window.staffMap[shift.user_name] : { color: '#555', initials: '??' };
            const pill = document.createElement('div');
            pill.className = 'shift-pill';
            pill.style.borderLeftColor = meta.color;
            pill.style.padding = currentView === 'week' ? '8px 10px' : '2px 4px';
            
            const area = shift.service_area || "";
            const locCode = area ? area.substring(0,3).toUpperCase() : "";

            pill.innerHTML = `
                <span class="pill-time" style="font-size: ${currentView === 'week' ? '11px' : '9px'}">${formatTime(shift.start_time)}</span>
                <span class="pill-name" style="font-size: ${currentView === 'week' ? '12px' : '10px'}">${currentView === 'week' ? shift.user_name : meta.initials}</span>
                ${(locCode && currentView === 'week') ? `<span class="pill-loc" style="color:${meta.color}">${locCode}</span>` : ''}
            `;
            
            pill.onclick = (e) => {
                e.stopPropagation();
                openDetailModal(shift);
            };
            container.appendChild(pill);
        });

        // --- 2. RENDER JOBS ---
       const jobs = (window.allJobs || []).filter(j => {
            if (!j.scheduled_start) return false;

            // Robust extraction of YYYY-MM-DD regardless of format
            if (!j.scheduled_start || !j.scheduled_start.includes('T')) return false;
const jobDate = j.scheduled_start.split('T')[0];

            
            // 1. Check if the job matches the current calendar day column
            if (jobDate !== dateKey) return false;
            
            // 2. Filter by Service Area
            if (areaFilter !== "ALL" && j.service_area !== areaFilter) return false;

            // 3. Status Filtering logic
            const assignments = (window.allAssignments || []).filter(a => a.job_id === j.job_id);
            const isAssigned = assignments.length > 0;

            if (jobStatusFilter === "UNASSIGNED" && isAssigned) return false;
            if (jobStatusFilter === "ASSIGNED" && !isAssigned) return false;
            
            return true;
        });

            

         jobs.forEach(job => {
			 console.log("RENDERING JOB:", job.job_id, job.scheduled_start);

            const assignments = (window.allAssignments || []).filter(a => a.job_id === job.job_id);
            const isAssigned = assignments.length > 0;

            const pill = document.createElement('div');
            pill.className = 'shift-pill';
			 pill.style.display = "block";
pill.style.zIndex = "10";
            pill.style.background = '#000';
            pill.style.border = `1px solid ${isAssigned ? 'var(--primary)' : 'var(--danger)'}`;
            pill.style.borderLeft = `4px solid ${isAssigned ? 'var(--primary)' : 'var(--danger)'}`;
			 // --- PURPLE OVERRIDE for Completed Jobs ---
            if (job.status === 'COMPLETE') {
                pill.style.background = '#5b21b6'; // Solid Purple Background
                pill.style.borderColor = '#8b5cf6'; // Lighter Purple Border
                pill.style.borderLeftColor = '#8b5cf6';
                
                // Optional: Update the "X CLN" badge to look purple too
                const badge = pill.querySelector('.pill-loc');
                if (badge) {
                    badge.style.background = '#8b5cf6';
                    badge.style.color = 'white';
                    badge.innerText = "DONE";
                }
            }

            pill.innerHTML = `
                <span class="pill-time" style="color:white; font-weight:800;">JOB</span>
                <span class="pill-name" style="color:white;">${job.first_name} ${job.last_name}</span>
                <div class="pill-loc" style="background:${isAssigned ? 'var(--primary)' : 'var(--danger)'}; color:black; font-weight:bold; top:2px; right:2px; opacity:1;">
                    ${assignments.length} CLN
                </div>
            `;

            pill.onclick = (e) => {
                e.stopPropagation();
                openJobAssignmentModal(job);
            };
			 pill.style.display = "block";
pill.style.opacity = "1";

            container.appendChild(pill);
        });

    } // This brace closes the for-loop of days
} // This brace closes the refreshUI function

   


        // --- MODAL LOGIC ---
        const modal = document.getElementById('scheduleModal');

        function openModal(shift = null, dateKey = null) {
            window.currentModalShift = shift; // Track what we are editing
            const title = document.getElementById('modalTitle');
            const delBtn = document.getElementById('deleteBtn');

            if(shift) {
                title.innerText = "Edit Shift";
                delBtn.style.display = 'block';
                document.getElementById('slotId').value = shift.id;
                document.getElementById('modalCleaner').value = shift.user_name;
                document.getElementById('modalDate').value = shift.date;
                document.getElementById('modalStart').value = shift.start_time.slice(0,5);
                document.getElementById('modalEnd').value = shift.end_time.slice(0,5);
               // This ensures that if the shift has an area (like Missoula), the dropdown selects it correctly
document.getElementById('modalArea').value = shift.service_area || "";
            } else {
                title.innerText = "Add New Shift";
                delBtn.style.display = 'none';
                document.getElementById('slotId').value = "";
                document.getElementById('modalDate').value = dateKey || new Date().toISOString().split('T')[0];
                document.getElementById('modalStart').value = "09:00";
                document.getElementById('modalEnd').value = "17:00";
            }
            modal.style.display = 'flex';
        }

        window.closeModal = function() { modal.style.display = 'none'; }
		window.closeAssignmentModal = function() {
    document.getElementById('jobAssignmentModal').style.display = 'none';
};

        // --- DATABASE ACTIONS ---
        async function saveShift() {
            const id = document.getElementById('slotId').value;
            const name = document.getElementById('modalCleaner').value;
            const date = document.getElementById('modalDate').value;
            const start = document.getElementById('modalStart').value;
            const end = document.getElementById('modalEnd').value;
            const area = document.getElementById('modalArea').value;

            if(!name || !date) return alert("Please select staff and date.");

            const meta = staffMap[name];
            const payload = {
                user_name: name,
                user_id: meta ? meta.id : null, 
                date: date, 
                start_time: start, 
                end_time: end, 
                service_area: area // Ensures "Missoula" is saved to the row
            };

            if(id) {
                await supabase.from('cleaner_availability_time_slots').update(payload).eq('id', id);
            } else {
                await supabase.from('cleaner_availability_time_slots').insert([payload]);
            }
            
            closeModal();
            loadData(); 
        }

        async function deleteShift() {
            const id = document.getElementById('slotId').value;
            if(confirm("Are you sure you want to remove this shift?")) {
                await supabase.from('cleaner_availability_time_slots').delete().eq('id', id);
                closeModal();
                loadData();
            }
        }

        // --- UTILS ---
        function getStartOfWeek(d) {
            const day = d.getDay();
            const diff = d.getDate() - day; 
            return new Date(d.setDate(diff));
        }
        function jumpDate(days) {
            currentDate.setDate(currentDate.getDate() + days);
            refreshUI();
        }
        function formatDate(d) { return d.toLocaleDateString('en-US', {month:'short', day:'numeric'}); }
        function formatTime(t) {
            if(!t) return "";
            let [h, m] = t.split(':');
            h = parseInt(h);
            const ampm = h >= 12 ? 'p' : 'a';
            h = h % 12 || 12;
            return `${h}${ampm}`;
        }
        function generateTimeOptions() {
            const s = document.getElementById('modalStart');
            const e = document.getElementById('modalEnd');
            for(let i=6; i<=22; i++) {
                const val = i < 10 ? `0${i}:00` : `${i}:00`;
                const label = formatTime(val);
                s.add(new Option(label, val)); e.add(new Option(label, val));
            }
        }
        function renderCalendarSkeleton() { refreshUI(); }

        // --- START ---
        initApp();
    }

function openDetailModal(shift) {
    const detailModal = document.getElementById('detailModal');
    
    // Safety check: ensure staffMap exists before accessing
    const currentStaffMap = window.staffMap || staffMap || {};
    const meta = currentStaffMap[shift.user_name] || { color: '#555', initials: '??' };
    
    // ... rest of your existing code
    
    // Fill data
    document.getElementById('viewCleaner').innerText = shift.user_name;
    document.getElementById('viewCleaner').style.color = meta.color;
    document.getElementById('viewDate').innerText = new Date(shift.date).toLocaleDateString('en-US', { 
        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' 
    });
    document.getElementById('viewTime').innerText = `${formatTime(shift.start_time)} to ${formatTime(shift.end_time)}`;
    
    const area = shift.service_area || "Not Assigned";
    document.getElementById('viewArea').innerHTML = `
        <span style="background: ${meta.color}22; color: ${meta.color}; padding: 4px 12px; border-radius: 20px; border: 1px solid ${meta.color}; font-weight: 700;">
            ${area}
        </span>
    `;

    // Link Edit Button
    document.getElementById('editFromDetail').onclick = () => {
        closeDetailModal();
        openModal(shift);
    };

    detailModal.style.display = 'flex';
}

function closeDetailModal() {
    document.getElementById('detailModal').style.display = 'none';
}

// --- JOB ASSIGNMENT & CONFLICT LOGIC ---
function openJobAssignmentModal(job) {
    const modal = document.getElementById('jobAssignmentModal');
    const assignJobIdEl = document.getElementById('assignJobId');

    if (!modal || !assignJobIdEl) {
        console.error("Job Assignment Modal DOM not ready");
        return;
    }

    // 1. POPULATE OPTIONS FIRST (So we can select one later)
    populateAssignCleanerSelect();

    // 2. Clear any extra rows from previous opens (Reset to just one row)
    const container = document.getElementById('cleanerAssignmentContainer');
    // Keep the first row (index 0), remove the rest
    while (container.children.length > 1) {
        container.removeChild(container.lastChild);
    }

    // 3. Fill Job Data
    assignJobIdEl.value = job.job_id;
    document.getElementById('editJobFirstName').value = job.first_name || '';
    document.getElementById('editJobLastName').value = job.last_name || '';
    document.getElementById('editJobArea').value = job.service_area || 'Billings';
    document.getElementById('editJobEmail').value = job.email || '';
    document.getElementById('editJobPhone').value = job.phone || '';
    document.getElementById('editJobAddress').value = job.address || '';
    document.getElementById('editJobCity').value = job.city || '';
    document.getElementById('editJobZip').value = job.zip_code || '';
    document.getElementById('editJobNotes').value = job.notes || '';
    document.getElementById('editJobDuration').value = job.duration_hours || '';
    document.getElementById('editJobManHours').value = job.total_man_hours || '';

    const priceEl = document.getElementById('assignJobPrice');
    if (priceEl) priceEl.innerText = job.price ? `$${job.price}` : '$0.00';

    if (job.scheduled_start) {
        document.getElementById('editJobTime').value = job.scheduled_start.split('T')[1].substring(0, 5);
    }

    // 4. Handle Assignments
    const assignments = (window.allAssignments || []).filter(a => a.job_id === job.job_id);
    const isAssigned = assignments.length > 0;

    // Badge Logic
    const badge = document.getElementById('jobStatusBadge');
    badge.innerText = isAssigned ? 'ASSIGNED' : 'UNASSIGNED';
    badge.style.background = isAssigned ? 'var(--primary)' : 'var(--danger)';
    badge.style.color = 'black';

    // Payout Logic
    document.getElementById('payoutType').value = (isAssigned && assignments[0].payout_type) ? assignments[0].payout_type : 'PERCENT';
    document.getElementById('payoutValue').value = (isAssigned && assignments[0].payout_value) ? assignments[0].payout_value : '';

    // 5. Set the Cleaner(s)
    const mainSelect = document.getElementById('assignCleanerSelect');
    
    if (isAssigned) {
        // --- PRIMARY CLEANER (First Dropdown) ---
        const firstAssignment = assignments[0];
        let firstName = "";
        // Find name by ID
        for (const [name, data] of Object.entries(window.staffMap || {})) {
            if (data.id === firstAssignment.cleaner_id) {
                firstName = name;
                break;
            }
        }
        if (firstName) mainSelect.value = firstName;
		// --- Loop to add rows for any extra cleaners (Cleaner #2, #3, etc.) ---
        assignments.slice(1).forEach(assignment => {
            // 1. Find the name for this specific assignment ID
            let foundName = "";
            for (const [name, data] of Object.entries(window.staffMap || {})) {
                if (data.id === assignment.cleaner_id) {
                    foundName = name;
                    break;
                }
            }
            
            // 2. Add the row to the UI
            const container = document.getElementById('cleanerAssignmentContainer');
            const newRow = document.createElement('div');
            newRow.className = 'cleaner-row';
            newRow.style.cssText = "display: flex; gap: 10px; align-items: center; margin-top: 10px;";
            
            const newSelect = document.createElement('select');
            newSelect.className = 'form-input cleaner-select';
            newSelect.style.cssText = "flex: 1; border-color: var(--primary);";
            newSelect.innerHTML = '<option value="">-- Select Cleaner --</option>';
            
            Object.keys(window.staffMap).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                newSelect.appendChild(opt);
            });

            if (foundName) newSelect.value = foundName;

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '✕';
            removeBtn.className = 'nav-icon-btn';
            removeBtn.style.cssText = "width:32px; height:32px; color:var(--danger); border-color:var(--danger); display:flex; align-items:center; justify-content:center;";
            removeBtn.onclick = () => newRow.remove();

            newRow.appendChild(newSelect);
            newRow.appendChild(removeBtn);
            container.appendChild(newRow);
        });

        // --- SECONDARY CLEANERS (If any) ---
        // If there are more assignments, we trigger the "Add" button logic to create rows
        assignments.slice(1).forEach(assignment => {
            // Create the UI row manually to ensure it populates
            const newRow = document.createElement('div');
            newRow.className = 'cleaner-row';
            newRow.style.cssText = "display: flex; gap: 10px; align-items: center; margin-top: 10px;";
            
            const newSelect = document.createElement('select');
            newSelect.className = 'form-input cleaner-select';
            newSelect.style.cssText = "flex: 1; border-color: var(--primary);";
            newSelect.innerHTML = '<option value="">-- Select Cleaner --</option>';
            
            let foundName = "";
            Object.keys(window.staffMap).forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                newSelect.appendChild(opt);
                // Check if this name matches the assignment ID
                if (window.staffMap[name].id === assignment.cleaner_id) {
                    foundName = name;
                }
            });

            if (foundName) newSelect.value = foundName;

            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = '✕';
            removeBtn.className = 'nav-icon-btn';
            removeBtn.style.cssText = "width:32px; height:32px; color:var(--danger); border-color:var(--danger); display:flex; align-items:center; justify-content:center;";
            removeBtn.onclick = () => newRow.remove();

            newRow.appendChild(newSelect);
            newRow.appendChild(removeBtn);
            container.appendChild(newRow);
        });

    } else {
        mainSelect.value = "";
    }

    // Show Modal
    modal.style.display = 'flex';
}



async function notifyCleaner() {
    const jobId = document.getElementById('assignJobId').value;
    const customerFirstName = document.getElementById('editJobFirstName').value || "";
const customerLastName  = document.getElementById('editJobLastName').value || "";

    const address = `${document.getElementById('editJobAddress').value}, 
${document.getElementById('editJobCity').value}, 
${document.getElementById('editJobZip').value}`;

    const time = document.getElementById('editJobTime').value;
	const durationHours = document.getElementById('editJobDuration').value || "0";
    const totalManHours = document.getElementById('editJobManHours').value || "0";
    const payoutAmount = document.getElementById('payoutValue').value || "0";
   const scheduledDate = window.allJobs
    .find(j => j.job_id === jobId)
    ?.scheduled_start
    ?.split('T')[0] || "N/A";
	const serviceType = window.allJobs
    .find(j => j.job_id === jobId)
    ?.service_type || "Standard Cleaning";
	const jobNotes = document.getElementById('editJobNotes').value || "";
	const payoutType = document.getElementById('payoutType').value;
const payoutValue = document.getElementById('payoutValue').value;




    
    // 1. Find all dropdowns
    const cleanerRows = document.querySelectorAll('.cleaner-select');
    
    // 2. Extract details
    const assignedStaff = Array.from(cleanerRows)
        .map(select => {
            const name = select.value;
            const details = window.staffMap[name] || {};
            return {
                name,
                cleaner_id: details.id,
                email: details.email 
            };
        })
        .filter(staff => staff.name && staff.name !== "");
	
	console.log("STAFF MAP SNAPSHOT", window.staffMap);
console.log("ASSIGNED STAFF", assignedStaff);


    if (assignedStaff.length === 0) {
        alert("Please assign at least one cleaner before notifying.");
        return;
    }

    // 3. This is where the email check BELONGS (inside the function)
    const invalid = assignedStaff.filter(c => !c.email);
    if (invalid.length > 0) {
        alert(`Cannot notify:\n` + invalid.map(c => `${c.name} has no email on file`).join('\n'));
        return;
    }

    const payload = {
    job_id: jobId,
    customer_first_name: customerFirstName,
    customer_last_name: customerLastName,
    address: address,
    scheduled_time: time,
    scheduled_date: scheduledDate,
    service_type: serviceType,
    job_notes: jobNotes,
		duration_hours: durationHours,
        total_man_hours: totalManHours,
        payout_amount: payoutAmount,
    cleaners: assignedStaff.map(c => ({
        name: c.name,
        email: c.email,
        payout: `${payoutType} ${payoutValue}`
    }))
};


    try {
        const response = await fetch("https://hook.us1.make.com/ika9psuwxp6yu2pal7upkp6way1vp77m", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            alert(`Notified ${assignedStaff.length} cleaner(s) successfully!`);
        } else {
            alert("Notification failed. Check your Make.com scenario.");
        }
    } catch (err) {
        console.error("Webhook Error:", err);
        alert("Error sending notification.");
    }
}

async function completeJob() {
    const jobId = document.getElementById('assignJobId').value;
    const firstName = document.getElementById('editJobFirstName').value;
    const lastName = document.getElementById('editJobLastName').value;
    const email = document.getElementById('editJobEmail').value;
    const phone = document.getElementById('editJobPhone').value;

    if (!email && !phone) {
        alert("Customer needs an email or phone number to send a review request.");
        return;
    }

// 1. Mark as Complete in Database
    const { error } = await window.adminSupabase
        .from('jobs')
        .update({ status: 'COMPLETE' })
        .eq('job_id', jobId);

    if (error) {
        console.error("Status Update Error:", error);
        alert("Failed to update job status.");
        return;
    }
	
    const payload = {
        job_id: jobId,
        first_name: firstName,
        last_name: lastName,
        email: email,
        phone: phone,
        timestamp: new Date().toISOString()
    };

    try {
        const response = await fetch("https://hook.us1.make.com/x6r5ybeybysjgklu6a9h68w4f45mhvpw", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            alert("Job marked complete! Review request sent.");
			document.getElementById('jobAssignmentModal').style.display = 'none';
        await loadData();
        } else {
            alert("Failed to send review request to Make.com.");
        }
    } catch (err) {
        console.error("Webhook Error:", err);
        alert("Error connecting to webhook.");
    }
}
	
async function saveJobAssignment() {
    const jobId = document.getElementById('assignJobId').value;
    const cleanerName = document.getElementById('assignCleanerSelect').value;
    const pType = document.getElementById('payoutType').value;
    const pValue = document.getElementById('payoutValue').value;
    
    // Get the new editable values from the modal
    const newArea = document.getElementById('editJobArea').value;
    const newTime = document.getElementById('editJobTime').value;

    if (!jobId || !cleanerName || !pValue) {
        alert("Please select a cleaner and payout amount.");
        return;
    }

    const cleanerId = window.staffMap[cleanerName]?.id;
    const originalJob = window.allJobs.find(j => j.job_id === jobId);

    // 1. Update the 'jobs' table with all details
    const { error: jobError } = await window.adminSupabase
        .from('jobs')
        .update({
            first_name: document.getElementById('editJobFirstName').value,
            last_name: document.getElementById('editJobLastName').value,
            service_area: document.getElementById('editJobArea').value,
            email: document.getElementById('editJobEmail').value,
            phone: document.getElementById('editJobPhone').value,
            address: document.getElementById('editJobAddress').value,
            city: document.getElementById('editJobCity').value,
            zip_code: document.getElementById('editJobZip').value,
            notes: document.getElementById('editJobNotes').value,
duration_hours: parseFloat(document.getElementById('editJobDuration').value) || 0,
			total_man_hours: parseFloat(document.getElementById('editJobManHours').value) || 0,
            scheduled_start: originalJob.scheduled_start.split('T')[0] + 'T' + document.getElementById('editJobTime').value + ':00'
        })
        .eq('job_id', jobId);
      

    // 2. Update/Insert the 'job_assignments' table
    const { error: assignError } = await window.adminSupabase
        .from('job_assignments')
        .upsert({
            job_id: jobId,
            cleaner_id: cleanerId,
            payout_type: pType,
            payout_value: parseFloat(pValue)
        }, { onConflict: 'job_id' });

    if (jobError || assignError) {
        console.error("Save Error:", jobError || assignError);
        alert("Failed to save changes.");
        return;
    }

    document.getElementById('jobAssignmentModal').style.display = 'none';
    await loadData(); // Refresh the calendar grid
}

document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'addMoreCleanersBtn') {
        const container = document.getElementById('cleanerAssignmentContainer');
        
        // Create new row
        const newRow = document.createElement('div');
        newRow.className = 'cleaner-row';
        newRow.style.cssText = "display: flex; gap: 10px; align-items: center; margin-top: 10px;";
        
        // Create select and fill with current staff list
        const newSelect = document.createElement('select');
        newSelect.className = 'form-input cleaner-select';
        newSelect.style.cssText = "flex: 1; border-color: var(--primary);";
        newSelect.innerHTML = '<option value="">-- Select Cleaner --</option>';
        
        Object.keys(window.staffMap).forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            newSelect.appendChild(opt);
        });

        // Add remove button
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '✕';
        removeBtn.className = 'nav-icon-btn';
        removeBtn.style.cssText = "width:32px; height:32px; color:var(--danger); border-color:var(--danger); display:flex; align-items:center; justify-content:center;";
        removeBtn.onclick = () => newRow.remove();

        newRow.appendChild(newSelect);
        newRow.appendChild(removeBtn);
        container.appendChild(newRow);
    }
});
	
function populateAssignCleanerSelect() {
    const select = document.getElementById('assignCleanerSelect');
    if (!select) return;

    select.innerHTML = '<option value="">-- Select Cleaner --</option>';

    Object.keys(window.staffMap).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
    });
}



</script>

<div class="modal-backdrop" id="jobAssignmentModal" style="display:none; align-items: center; justify-content: center;">
    <div class="modal-card" style="border: 1px solid var(--primary); width: 450px; display: flex; flex-direction: column; max-height: 90vh;">
		<input type="hidden" id="assignJobId">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0;">
            <h3 class="modal-title" style="margin: 0;">Job Assignment</h3>
            <span id="jobStatusBadge" style="font-size: 10px; padding: 4px 8px; border-radius: 4px; font-weight: bold;"></span>
        </div>
        
       <div style="overflow-y: auto; flex: 1; padding-right: 10px; margin-bottom: 20px; scrollbar-width: thin; scrollbar-color: var(--primary) transparent;" id="modalScrollBody">
            
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; background: var(--bg-body); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">

    <div style="grid-column: span 2;">
        <label class="form-label" style="margin-bottom: 2px;">Customer Name</label>
        <div style="display: flex; gap: 10px;">
            <input type="text" id="editJobFirstName" class="form-input" placeholder="First Name" style="padding: 4px; height: 32px; font-size: 13px;">
            <input type="text" id="editJobLastName" class="form-input" placeholder="Last Name" style="padding: 4px; height: 32px; font-size: 13px;">
        </div>
    </div>
    <div>
        <label class="form-label" style="margin-bottom: 2px;">Service Area</label>
        <select id="editJobArea" class="form-input" style="padding: 4px; height: 32px; font-size: 13px;">
            <option value="Billings">Billings</option>
            <option value="Bozeman">Bozeman</option>
            <option value="Missoula">Missoula</option>
        </select>
    </div>
    <div>
        <label class="form-label" style="margin-bottom: 2px;">Email</label>
        <input type="email" id="editJobEmail" class="form-input" style="padding: 4px; height: 32px; font-size: 13px;">
    </div>
    <div>
        <label class="form-label" style="margin-bottom: 2px;">Phone</label>
        <input type="text" id="editJobPhone" class="form-input" style="padding: 4px; height: 32px; font-size: 13px;">
    </div>
    <div>
        <label class="form-label" style="margin-bottom: 2px;">Address</label>
        <input type="text" id="editJobAddress" class="form-input" style="padding: 4px; height: 32px; font-size: 13px;">
    </div>
    <div>
        <label class="form-label" style="margin-bottom: 2px;">City</label>
        <input type="text" id="editJobCity" class="form-input" style="padding: 4px; height: 32px; font-size: 13px;">
    </div>
    <div>
        <label class="form-label" style="margin-bottom: 2px;">Zip Code</label>
        <input type="text" id="editJobZip" class="form-input" style="padding: 4px; height: 32px; font-size: 13px;">
    </div>
    <div style="grid-column: span 2;">
        <label class="form-label" style="margin-bottom: 2px;">Internal Notes</label>
        <textarea id="editJobNotes" class="form-input" style="padding: 8px; height: 60px; font-size: 13px; resize: none;"></textarea>
    </div>
    <div>
        <label class="form-label" style="margin-bottom: 2px;">Start Time</label>
        <input type="time" id="editJobTime" class="form-input" style="padding: 4px; height: 32px; font-size: 13px;">
    </div>
   <div>
        <label class="form-label" style="margin-bottom: 2px;">Duration (Clock Hrs)</label>
        <input type="number" id="editJobDuration" class="form-input" placeholder="e.g. 3" style="padding: 4px; height: 32px; font-size: 13px;">
    </div>
    <div>
        <label class="form-label" style="margin-bottom: 2px;">Total Man Hours</label>
        <input type="number" id="editJobManHours" class="form-input" placeholder="e.g. 6" style="padding: 4px; height: 32px; font-size: 13px;">
    </div>
</div> <div style="margin-bottom: 20px; background: var(--bg-body); padding: 10px; border-radius: 8px; border: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
    <label class="form-label" style="margin: 0;">Job Price</label>
    <div id="assignJobPrice" style="font-weight: 700; color: var(--primary); font-size: 16px;"></div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
            <div class="form-group" style="margin-bottom:0;">
                <label class="form-label">Payout Type</label>
                <select id="payoutType" class="form-input">
                    <option value="PERCENT">Percent (%)</option>
                    <option value="FLAT">Flat Rate ($)</option>
                </select>
            </div>
            <div class="form-group" style="margin-bottom:0;">
                <label class="form-label">Payout Amount</label>
                <input type="number" id="payoutValue" class="form-input" placeholder="e.g. 50">
            </div>
        </div>

      <div class="form-group">
    <label class="form-label">Assigned Cleaners</label>

    <div id="cleanerAssignmentContainer" style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;">
        <div class="cleaner-row" style="display: flex; gap: 10px; align-items: center;">
            <select id="assignCleanerSelect" class="form-input cleaner-select" style="flex: 1; border-color: var(--primary);">
                <option value="">-- Select Cleaner --</option>
            </select>
            <div style="width: 32px;"></div>
        </div>
    </div>

    <button type="button" id="addMoreCleanersBtn"
        class="primary-btn"
        style="background: transparent; border: 1px solid var(--primary); color: var(--primary); width: 100%; font-size: 11px;">
        + Add Another Cleaner
    </button>
</div>


        <div id="conflictWarning" style="display:none; margin-top: 10px; padding: 10px; background: rgba(245, 158, 11, 0.1); border: 1px solid #f59e0b; border-radius: 6px; font-size: 12px; color: #f59e0b;">
            ⚠️ <strong>Conflict:</strong> This cleaner hasn't posted availability for this date.
        </div>
</div> 



        <div class="modal-actions" style="margin-top: 25px;">
            <button class="primary-btn btn-full" onclick="saveJobAssignment()">Save Assignment</button>
            <button type="button" class="primary-btn btn-full" style="background: #3b82f6; margin-left: 10px;" onclick="notifyCleaner()">Notify Cleaner</button>
			<button type="button" class="primary-btn btn-full" style="background: #8b5cf6; margin-left: 10px;" onclick="completeJob()">Job Complete</button>
            <button class="nav-icon-btn" style="width:40px;" onclick="closeAssignmentModal()">✕</button>
        </div>
    </div>
</div>
</body>
</html>

<!-- fresh pages init -->
















